/**
 * Object:  jsHtml5AudioRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/jsHtml5AudioRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Record live audio stream in html5 with echo cancellation, save it on server or download directly from browser
 */

var jsHtml5AudioRecorder=function(){};jsHtml5AudioRecorder.prototype={audioContext:"",microphone:"",recIndex:0,Recorder:false,mediaPath:"",phpFile:"",fftSize:2048,initAudio:function(){if(!navigator.getUserMedia)navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;if(!navigator.cancelAnimationFrame)navigator.cancelAnimationFrame=navigator.webkitCancelAnimationFrame||navigator.mozCancelAnimationFrame;if(!navigator.requestAnimationFrame)navigator.requestAnimationFrame=navigator.webkitRequestAnimationFrame||navigator.mozRequestAnimationFrame;window.onload=this.onLoad()},onLoad:function(){try{this.audioContext=new AudioContext;console.log("Audio context set up.");console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(e){alert("No web audio support in this browser!")}navigator.getUserMedia({audio:true},this.startStream.bind(this),function(e){alert("No audio stream!");console.log(e)})},startStream:function(e){this.inputPoint=this.audioContext.createGain();this.microphone=this.audioContext.createMediaStreamSource(e);this.microphone.connect(this.inputPoint);var t=this.audioContext.createAnalyser();t.fftSize=this.fftSize;this.inputPoint.connect(t);this.Recorder=new Recorder(this.inputPoint);var n=this.audioContext.createGain();n.gain.value=0;this.inputPoint.connect(n);n.connect(this.audioContext.destination)},startRecording:function(){this.Recorder&&this.Recorder.record();console.log("Recording audio...")},stopRecording:function(e){this.Recorder&&this.Recorder.stop();this.Recorder&&this.Recorder.exportWAV(function(t){console.log(t);if(e==="save"){this.save(t)}else if(e==="download"){this.download(t)}else{this.save(t)}}.bind(this));this.Recorder.clear();console.log("Stop Recording audio!")},save:function(e){var t="path="+this.mediaPath+"&format=.wav";var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){console.log(n.response)}}.bind(this);n.open("post",this.phpFile+"?"+t,true);n.setRequestHeader("X-Requested-With","XMLHttpRequest");n.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");n.setRequestHeader("cache-Control","post-check=0, pre-check=0");n.setRequestHeader("cache-Control","max-age=0");n.setRequestHeader("Pragma","no-cache");n.setRequestHeader("X-File-Name",encodeURIComponent("1"));n.setRequestHeader("Content-Type","application/octet-stream");n.send(e)},download:function(e){var t=window.URL.createObjectURL(e);var n=document.createElement("audio");var r=document.createElement("a");var i=(new Date).toISOString();n.controls=true;n.src=t;r.href=t;r.id=i;r.download=i+".wav";r.innerHTML=r.download;r.style.display="none";r.style.visibility="hidden";document.body.appendChild(r);document.getElementById(r.id).click();document.getElementById(r.id).remove()}}